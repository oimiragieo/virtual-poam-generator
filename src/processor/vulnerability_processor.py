"""
Vulnerability Data Processor for vISSM
Processes and categorizes vulnerability data from Nessus reports
"""

from typing import List, Dict, Any
from dataclasses import dataclass
from collections import defaultdict
from src.parser.nessus_parser import NessusReport, Vulnerability


@dataclass
class VulnerabilitySummary:
    """Summary statistics for vulnerabilities"""

    total_vulnerabilities: int
    by_severity: Dict[int, int]
    by_family: Dict[str, int]
    by_host: Dict[str, int]
    critical_count: int
    high_count: int
    medium_count: int
    low_count: int
    info_count: int


@dataclass
class HostSummary:
    """Summary for a specific host"""

    hostname: str
    ip: str
    os: str
    total_vulnerabilities: int
    critical_vulnerabilities: int
    high_vulnerabilities: int
    medium_vulnerabilities: int
    low_vulnerabilities: int
    info_vulnerabilities: int
    risk_score: float


class VulnerabilityProcessor:
    """Processes and analyzes vulnerability data"""

    def __init__(self, report: NessusReport):
        self.report = report
        self.summary = None
        self.host_summaries = []

    def process(self) -> Dict[str, Any]:
        """Process the vulnerability data and return analysis"""
        self._calculate_summary()
        self._calculate_host_summaries()
        self._calculate_risk_scores()

        return {
            "summary": self.summary,
            "host_summaries": self.host_summaries,
            "top_vulnerabilities": self._get_top_vulnerabilities(),
            "vulnerability_trends": self._analyze_trends(),
            "recommendations": self._generate_recommendations(),
        }

    def _calculate_summary(self):
        """Calculate overall vulnerability summary"""
        severity_counts = defaultdict(int)
        family_counts = defaultdict(int)
        host_counts = defaultdict(int)

        total_vulns = 0
        critical = high = medium = low = info = 0

        for host in self.report.hosts:
            host_counts[host.name] = len(host.vulnerabilities)

            for vuln in host.vulnerabilities:
                total_vulns += 1
                severity_counts[vuln.severity] += 1
                family_counts[vuln.plugin_family] += 1

                if vuln.severity == 4:
                    critical += 1
                elif vuln.severity == 3:
                    high += 1
                elif vuln.severity == 2:
                    medium += 1
                elif vuln.severity == 1:
                    low += 1
                else:
                    info += 1

        self.summary = VulnerabilitySummary(
            total_vulnerabilities=total_vulns,
            by_severity=dict(severity_counts),
            by_family=dict(family_counts),
            by_host=dict(host_counts),
            critical_count=critical,
            high_count=high,
            medium_count=medium,
            low_count=low,
            info_count=info,
        )

    def _calculate_host_summaries(self):
        """Calculate summaries for each host"""
        for host in self.report.hosts:
            critical = high = medium = low = info = 0

            for vuln in host.vulnerabilities:
                if vuln.severity == 4:
                    critical += 1
                elif vuln.severity == 3:
                    high += 1
                elif vuln.severity == 2:
                    medium += 1
                elif vuln.severity == 1:
                    low += 1
                else:
                    info += 1

            host_summary = HostSummary(
                hostname=host.properties.hostname or host.name,
                ip=host.properties.ip or host.name,
                os=host.properties.os,
                total_vulnerabilities=len(host.vulnerabilities),
                critical_vulnerabilities=critical,
                high_vulnerabilities=high,
                medium_vulnerabilities=medium,
                low_vulnerabilities=low,
                info_vulnerabilities=info,
                risk_score=0.0,  # Will be calculated next
            )

            self.host_summaries.append(host_summary)

    def _calculate_risk_scores(self):
        """Calculate risk scores for each host"""
        for host_summary in self.host_summaries:
            # Risk score calculation: Critical=10, High=7, Medium=4, Low=2, Info=1
            risk_score = (
                host_summary.critical_vulnerabilities * 10
                + host_summary.high_vulnerabilities * 7
                + host_summary.medium_vulnerabilities * 4
                + host_summary.low_vulnerabilities * 2
                + host_summary.info_vulnerabilities * 1
            )

            # Normalize to 0-100 scale
            max_possible_score = host_summary.total_vulnerabilities * 10
            if max_possible_score > 0:
                host_summary.risk_score = min(
                    100.0, (risk_score / max_possible_score) * 100
                )
            else:
                host_summary.risk_score = 0.0

    def _get_top_vulnerabilities(self, limit: int = 10) -> List[Dict[str, Any]]:
        """Get the most common vulnerabilities across all hosts"""
        vuln_counts = defaultdict(int)
        vuln_details = {}

        for host in self.report.hosts:
            for vuln in host.vulnerabilities:
                key = f"{vuln.plugin_id}:{vuln.plugin_name}"
                vuln_counts[key] += 1
                if key not in vuln_details:
                    vuln_details[key] = {
                        "plugin_id": vuln.plugin_id,
                        "plugin_name": vuln.plugin_name,
                        "plugin_family": vuln.plugin_family,
                        "severity": vuln.severity,
                        "description": (
                            vuln.description[:200] + "..."
                            if len(vuln.description) > 200
                            else vuln.description
                        ),
                    }

        # Sort by count and severity
        sorted_vulns = sorted(
            vuln_counts.items(),
            key=lambda x: (x[1], vuln_details[x[0]]["severity"]),
            reverse=True,
        )

        top_vulns = []
        for vuln_key, count in sorted_vulns[:limit]:
            details = vuln_details[vuln_key].copy()
            details["affected_hosts"] = count
            top_vulns.append(details)

        return top_vulns

    def _analyze_trends(self) -> Dict[str, Any]:
        """Analyze vulnerability trends and patterns"""
        # Group by plugin family
        family_analysis = defaultdict(
            lambda: {"count": 0, "hosts": set(), "severities": []}
        )

        for host in self.report.hosts:
            for vuln in host.vulnerabilities:
                family = vuln.plugin_family
                family_analysis[family]["count"] += 1
                family_analysis[family]["hosts"].add(host.name)
                family_analysis[family]["severities"].append(vuln.severity)

        # Calculate family statistics
        family_stats = {}
        for family, data in family_analysis.items():
            family_stats[family] = {
                "total_vulnerabilities": data["count"],
                "affected_hosts": len(data["hosts"]),
                "avg_severity": (
                    sum(data["severities"]) / len(data["severities"])
                    if data["severities"]
                    else 0
                ),
                "max_severity": max(data["severities"]) if data["severities"] else 0,
            }

        return {
            "by_family": family_stats,
            "most_common_families": sorted(
                family_stats.items(),
                key=lambda x: x[1]["total_vulnerabilities"],
                reverse=True,
            )[:5],
        }

    def _generate_recommendations(self) -> List[str]:
        """Generate security recommendations based on findings"""
        recommendations = []

        if self.summary.critical_count > 0:
            recommendations.append(
                f"URGENT: {self.summary.critical_count} critical vulnerabilities found. Immediate patching required."
            )

        if self.summary.high_count > 10:
            recommendations.append(
                f"High priority: {self.summary.high_count} high-severity vulnerabilities need attention within 30 days."
            )

        # Check for common high-risk families
        top_families = self._analyze_trends()["most_common_families"]
        for family, stats in top_families[:3]:
            if stats["avg_severity"] > 2.5:
                recommendations.append(
                    f"Focus on {family} vulnerabilities - high average severity ({stats['avg_severity']:.1f})"
                )

        # OS-specific recommendations
        os_vulns = defaultdict(int)
        for host in self.report.hosts:
            if host.properties.os:
                os_vulns[host.properties.os] += len(host.vulnerabilities)

        if os_vulns:
            most_vulnerable_os = max(os_vulns.items(), key=lambda x: x[1])
            recommendations.append(
                f"Consider OS updates for {most_vulnerable_os[0]} - {most_vulnerable_os[1]} vulnerabilities found"
            )

        return recommendations

    def get_hosts_by_risk(self, min_risk_score: float = 50.0) -> List[HostSummary]:
        """Get hosts with risk score above threshold"""
        return [
            host for host in self.host_summaries if host.risk_score >= min_risk_score
        ]

    def get_vulnerabilities_by_severity(
        self, min_severity: int = 3
    ) -> List[Vulnerability]:
        """Get all vulnerabilities with severity >= min_severity"""
        high_severity = []
        for host in self.report.hosts:
            for vuln in host.vulnerabilities:
                if vuln.severity >= min_severity:
                    high_severity.append(vuln)
        return high_severity

    def export_summary_csv(self, filename: str):
        """Export vulnerability summary to CSV"""
        import csv

        with open(filename, "w", newline="", encoding="utf-8") as csvfile:
            writer = csv.writer(csvfile)

            # Write header
            writer.writerow(
                [
                    "Host",
                    "IP",
                    "OS",
                    "Total Vulns",
                    "Critical",
                    "High",
                    "Medium",
                    "Low",
                    "Info",
                    "Risk Score",
                ]
            )

            # Write host data
            for host in self.host_summaries:
                writer.writerow(
                    [
                        host.hostname,
                        host.ip,
                        host.os,
                        host.total_vulnerabilities,
                        host.critical_vulnerabilities,
                        host.high_vulnerabilities,
                        host.medium_vulnerabilities,
                        host.low_vulnerabilities,
                        host.info_vulnerabilities,
                        f"{host.risk_score:.1f}",
                    ]
                )


def process_nessus_report(report: NessusReport) -> Dict[str, Any]:
    """Convenience function to process a Nessus report"""
    processor = VulnerabilityProcessor(report)
    return processor.process()


if __name__ == "__main__":
    # Test the processor
    import sys
    from src.parser.nessus_parser import parse_nessus_file

    if len(sys.argv) != 2:
        print("Usage: python vulnerability_processor.py <nessus_file>")
        sys.exit(1)

    try:
        # Parse the file
        report = parse_nessus_file(sys.argv[1])

        # Process the data
        processor = VulnerabilityProcessor(report)
        results = processor.process()

        # Print summary
        summary = results["summary"]
        print("Vulnerability Analysis Summary:")
        print(f"  Total vulnerabilities: {summary.total_vulnerabilities}")
        print(f"  Critical: {summary.critical_count}")
        print(f"  High: {summary.high_count}")
        print(f"  Medium: {summary.medium_count}")
        print(f"  Low: {summary.low_count}")
        print(f"  Info: {summary.info_count}")

        # Print top vulnerabilities
        print("\nTop Vulnerabilities:")
        for i, vuln in enumerate(results["top_vulnerabilities"][:5], 1):
            print(
                f"  {i}. {vuln['plugin_name']} (Severity: {vuln['severity']}, Hosts: {vuln['affected_hosts']})"
            )

        # Print recommendations
        print("\nRecommendations:")
        for rec in results["recommendations"]:
            print(f"  - {rec}")

    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)
